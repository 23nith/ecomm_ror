#!/bin/bash -e

# Export the PIDFILE environment variable
export PIDFILE="tmp/pids/server.pid"

# Function to check if a process exists by PID
process_exists() {
    kill -0 "$1" 2>/dev/null
}

# Function to kill process by PID
kill_process() {
    if process_exists "$1"; then
        echo "Killing process with PID $1..."
        kill "$1"
    fi
}

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
    ./bin/rails db:prepare &
    rails_pid=$!

    # Function to monitor the master process and kill it if it crashes
    monitor_master_process() {
        wait "$rails_pid"
        master_pid=$(head -n 1 "$PIDFILE")
        kill_process "$master_pid"
    }

    monitor_master_process &
    monitor_pid=$!

    # Wait for both the Rails server and the monitor process to exit
    wait "$rails_pid" "$monitor_pid"
else
    # If not running the Rails server, simply execute the command
    exec "${@}"
fi
